# ロケスマ情報抽出ツール

このプロジェクトは、チェーン店検索サービス「ロケスマWEB」から店舗情報を抽出し、距離を含めて Excel に出力するための Streamlit アプリケーションです。中心住所とカテゴリを指定すると、自動的にブラウザを操作して地図上のマーカーをクリックし、詳細パネルから店舗名・住所・電話番号・営業時間・緯度・縦度を取得します。重複を排除したうえで、中心地点からの直線距離を計算して一覧表として表示し、Excel ファイルとして保存・ダウンロードできます。

## セットアップ手順

1. **リポジトリを複製**

   ```bash
   git clone <このリポジトリのURL>
   cd lokesma_streamlit_app
   ```

2. **依存ライブラリのインストール**

   Python 3.9 以上が必要です。仮想環境の利用を推奨します。

   ```bash
   pip install -r requirements.txt
   ```

3. **Playwright ブラウザの展開**

   Playwright で使用する Chromium バイナリをプロジェクト直下の `ms-playwright` ディレクトリにダウンロードします。初回のみ実行してください。

   ```bash
   python postinstall_playwright.py
   ```

4. **アプリの起動**

   Windows の場合は `run_app.bat` を、Linux/macOS の場合は `run_app.sh` を実行します。または直接 `streamlit run app.py` を実行しても構いません。

   ```bash
   # Windows
   run_app.bat

   # Linux/Mac
   bash run_app.sh
   ```

   起動後、ブラウザで `http://localhost:8501` にアクセスすると UI が表示されます。

## 使い方

1. サイドバーの **住所** に中心となる住所を入力します。
2. **ズームレベル** を 8〜18 の範囲で指定します。数値が大きいほど拡大表示になります。
3. **カテゴリ** から抽出したいカテゴリを複数選択します。リストは固定ですが、サイトのカテゴリパネルに存在しない「病院・診療所」は検索バー経由で必ず処理されます。
4. **ヘッドレスモード** をオンにするとブラウザが表示されずバックグラウンドで実行されます。オフにすると実際のブラウザ画面を確認しながら処理できます。
5. **最大件数** で抽出する上限を指定できます。0 または未入力の場合は全件取得します。
6. **抽出を実行** ボタンを押すと処理が始まります。進捗ログが画面に表示され、完了すると結果表が表示されます。
7. 結果は `C:\Users\user\Desktop` に `ロケスマ抽出_YYYYMMDD_HHMMSS.xlsx` という名前で保存されます。また画面上のダウンロードボタンから直接ダウンロードすることもできます。

## ファイル構成

- `app.py` — Streamlit アプリ本体。UI 定義および結果表示・エクスポートを行います。
- `scraper.py` — Playwright を用いたスクレイピングロジック。マーカーのクリック、詳細抽出、距離計算を担当します。
- `selectors.py` — セレクタ候補群。サイト構造が変わった場合はここを更新することで対応できます。
- `utils.py` — 正規表現抽出、文字列正規化、Haversine 距離計算などのユーティリティ。
- `postinstall_playwright.py` — Playwright のブラウザバイナリをダウンロードするスクリプト。
- `requirements.txt` — 依存パッケージ一覧。
- `run_app.bat` / `run_app.sh` — アプリ起動用スクリプト。
- `.streamlit/config.toml` — Streamlit サーバ設定。
- # ロケスマ情報抽出ツール

このプロジェクトは、チェーン店検索サービス「ロケスマWEB」から店舗情報を抽出し、距離を含めて Excel に出力するための Streamlit アプリケーションです。中心住所とカテゴリを指定すると、自動的にブラウザを操作して地図上のマーカーをクリックし、詳細パネルから店舗名・住所・電話番号・営業時間・緯度・縦度を取得します。重複を排除したうえで、中心地点からの直線距離を計算して一覧表として表示し、Excel ファイルとして保存・ダウンロードできます。

## セットアップ手順

1. **リポジトリを複製**

   ```bash
   git clone <このリポジトリのURL>
   cd lokesma_streamlit_app
   ```

2. **依存ライブラリのインストール**

   Python 3.9 以上が必要です。仮想環境の利用を推奨します。

   ```bash
   pip install -r requirements.txt
   ```

3. **Playwright ブラウザの展開**

   Playwright で使用する Chromium バイナリをプロジェクト直下の `ms-playwright` ディレクトリにダウンロードします。初回のみ実行してください。

   ```bash
   python postinstall_playwright.py
   ```

4. **アプリの起動**

   Windows の場合は `run_app.bat` を、Linux/macOS の場合は `run_app.sh` を実行します。または直接 `streamlit run app.py` を実行しても構いません。

   ```bash
   # Windows
   run_app.bat

   # Linux/Mac
   bash run_app.sh
   ```

   起動後、ブラウザで `http://localhost:8501` にアクセスすると UI が表示されます。

## 使い方

1. サイドバーの **住所** に中心となる住所を入力します。
2. **ズームレベル** を 8〜18 の範囲で指定します。数値が大きいほど拡大表示になります。
3. **カテゴリ** から抽出したいカテゴリを複数選択します。リストは固定ですが、サイトのカテゴリパネルに存在しない「病院・診療所」は検索バー経由で必ず処理されます。
4. **ヘッドレスモード** をオンにするとブラウザが表示されずバックグラウンドで実行されます。オフにすると実際のブラウザ画面を確認しながら処理できます。
5. **最大件数** で抽出する上限を指定できます。0 または未入力の場合は全件取得します。
6. **抽出を実行** ボタンを押すと処理が始まります。進捗ログが画面に表示され、完了すると結果表が表示されます。
7. 結果は `C:\\Users\\user\\Desktop` に `ロケスマ抽出_YYYYMMDD_HHMMSS.xlsx` という名前で保存されます。また画面上のダウンロードボタンから直接ダウンロードすることもできます。

## ファイル構成

- `app.py` — Streamlit アプリ本体。UI 定義および結果表示・エクスポートを行います。
- `scraper.py` — Playwright を用いたスクレイピングロジック。マーカーのクリック、詳細抽出、距離計算を担当します。
- `selectors.py` — セレクタ候補群。サイト構造が変わった場合はここを更新することで対応できます。
- `utils.py` — 正規表現抽出、文字列正規化、Haversine 距離計算などのユーティリティ。
- `postinstall_playwright.py` — Playwright のブラウザバイナリをダウンロードするスクリプト。
- `requirements.txt` — 依存パッケージ一覧。
- `run_app.bat` / `run_app.sh` — アプリ起動用スクリプト。
- `.streamlit/config.toml` — Streamlit サーバ設定。
- `tests/` — 簡易スモークテスト。
- `scripts/smoke_run.bat` — Windows 用テスト実行スクリプト。
- `logs/` — 実行時ログ。`app_YYYYMMDD.log` が生成されます。
- `ms-playwright/` — `postinstall_playwright.py` により生成されるブラウザディレクトリ。

## ログとトラブルシュート

処理中の進捗ログは、画面に随時表示され、同時に `logs` ディレクトリ配下のファイルにも出力されます。エラーが発生した場合は、ログファイルを確認することで原因を追跡できます。

サイトの DOM 構造が変更された場合、一部のデータが取得できなくなる可能性があります。その際は `selectors.py` 内のセレクタ候補を更新してください。

ネットワークが不安定でブラウザの読み込みに失敗した場合は、リトライ処理が働きますが、それでも失敗する場合は時間を置いて再実行してください。

## 既知の制約

- 本ツールはロケスマWEBの非公式ツールであり、サイト仕様の変更により動作しなくなる可能性があります。
- 取得した緯度・経度は、サイト上から取得できない場合に中心座標を使用することがあります。この場合、距離計算が不正確になることがあります。
- 大量のマーカーが存在するカテゴリを選択すると処理時間が長くなることがあります。必要に応じて「最大件数」で上限を設定してください。

## テスト（スモークテスト）

`tests` ディレクトリには、特定の住所・カテゴリで抽出処理を実行し、Excel ファイルの生成とデータ項目の存在を確認するスモークテストが含まれています。Windows 環境では `scripts/smoke_run.bat` から実行できます。

```bash
cd lokesma_streamlit_app
python postinstall_playwright.py
pytest -v tests
```

各テストはヘッドレスモードで実行され、結果の Excel が `C:\\Users\\user\\Desktop` に生成されることを確認します。`tests/` — 簡易スモークテスト。
- `scripts/smoke_run.bat` — Windows 用テスト実行スクリプト。
- `logs/` — 実行時ログ。`app_YYYYMMDD.log` が生成されます。
- `ms-playwright/` — `postinstall_playwright.py` により生成されるブラウザディレクトリ。

## ログとトラブルシュート

処理中の進捗ログは画面に随時表示され、同時に `logs` ディレクトリ配下のファイルにも出力されます。エラーが発生した場合は、ログファイルを確認することで原因を追跡できます。

サイトの DOM 構造が変更された場合、一部のデータが取得できなくなる可能性があります。その際は `selectors.py` 内のセレクタ候補を更新してください。

ネットワークが不安定でブラウザの読み込みに失敗した場合は、リトライ処理が働きますが、それでも失敗する場合は時間を置いて再実行してください。

## 既知の制約

- 本ツールはロケスマWEBの非公式ツールであり、サイト仕様の変更により動作しなくなる可能性があります。
- 取得した緯度・経度は、サイト上から取得できない場合に中心座標を使用することがあります。この場合、距離計算が不正確になることがあります。
- 大量のマーカーが存在するカテゴリを選択すると処理時間が長くなることがあります。必要に応じて「最大件数」で上限を設定してください。

## テスト（スモークテスト）

`tests` ディレクトリには、特定の住所・カテゴリで抽出処理を実行し、Excel ファイルの生成とデータ項目の存在を確認するスモークテストが含まれています。Windows 環境では `scripts/smoke_run.bat` から実行できます。

```bash
cd lokesma_streamlit_app
python postinstall_playwright.py
pytest -v tests
```

各テストはヘッドレスモードで実行され、結果の Excel が `C:\Users\user\Desktop` に生成されることを確認します。
